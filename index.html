<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Feliz Aniversario Cindy ‚ô•</title>
<meta name="description" content="Galaxia interactiva de aniversario con coraz√≥n 3D">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

#galaxy-canvas {
  position: fixed;
  top: 0;
  left: 0;
  background: #000;
  display: block;
  touch-action: none;
  width: 100%;
  height: 100%;
  transition: opacity 0.8s ease;
}

#fx {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 50;
}

.error {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: #fff;
  background: rgba(0, 0, 0, 0.7);
  padding: 10px 20px;
  border-radius: 8px;
  display: none;
  z-index: 200;
}

#cartita-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 120px;
  height: 120px;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 100;
  transition: all 0.3s ease;
  filter: drop-shadow(0 8px 20px rgba(255, 100, 150, 0.6));
}

#cartita-btn:hover {
  transform: scale(1.15);
  filter: drop-shadow(0 12px 30px rgba(255, 100, 150, 0.9));
}

#cartita-btn img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

#cartita-label {
  position: fixed;
  bottom: 10px;
  right: 30px;
  color: white;
  font-size: 14px;
  font-weight: bold;
  text-align: center;
  z-index: 100;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
  animation: pulse-text 2s infinite;
}

@keyframes pulse-text {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 1; }
}

/* Modal Overlay para la carta */
#carta-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(8px);
  display: none;
  z-index: 200;
  opacity: 0;
  transition: opacity 0.5s ease;
  align-items: center;
  justify-content: center;
  overflow-y: auto;
  padding: 20px;
}

#carta-modal-overlay.active {
  display: flex;
  opacity: 1;
}

/* Carta Container con glassmorphism */
#carta-container {
  position: relative;
  max-width: 520px;
  width: 90%;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 24px;
  padding: 40px 32px;
  box-shadow: 0 8px 32px rgba(255, 100, 150, 0.3),
              0 0 0 1px rgba(255, 255, 255, 0.18) inset;
  border: 1px solid rgba(255, 255, 255, 0.18);
  transform: scale(0);
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  max-height: 85vh;
  overflow-y: auto;
}

#carta-modal-overlay.active #carta-container {
  animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes popIn {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  60% {
    transform: scale(1.05);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

#carta-modal-overlay.closing #carta-container {
  animation: fadeOut 0.4s ease forwards;
}

@keyframes fadeOut {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(0.85);
    opacity: 0;
  }
}

/* T√≠tulo de la carta */
.carta-title {
  font-family: 'Playfair Display', serif;
  font-size: 32px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.95);
  text-align: center;
  margin-bottom: 28px;
  text-shadow: 0 2px 20px rgba(255, 100, 150, 0.6);
  letter-spacing: 0.5px;
  animation: titleFadeIn 0.8s ease 0.3s backwards;
}

@keyframes titleFadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Bot√≥n de cerrar */
#close-carta-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 36px;
  height: 36px;
  background: rgba(255, 100, 150, 0.25);
  border: 1.5px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: rgba(255, 255, 255, 0.9);
  transition: all 0.3s ease;
  z-index: 10;
  backdrop-filter: blur(10px);
}

#close-carta-btn:hover {
  background: rgba(255, 100, 150, 0.4);
  transform: rotate(90deg) scale(1.1);
  box-shadow: 0 0 20px rgba(255, 100, 150, 0.5);
}

/* Texto de la carta */
.carta-text {
  color: rgba(255, 255, 255, 0.92);
  line-height: 1.8;
  font-size: 16px;
  margin-bottom: 18px;
  opacity: 0;
  animation: fadeIn 0.8s ease forwards;
  font-family: 'Poppins', sans-serif;
  font-weight: 400;
  text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
}

.carta-text:nth-child(2) { animation-delay: 0.4s; }
.carta-text:nth-child(3) { animation-delay: 0.5s; }
.carta-text:nth-child(4) { animation-delay: 0.6s; }
.carta-text:nth-child(5) { animation-delay: 0.7s; }
.carta-text:nth-child(6) { animation-delay: 0.8s; }
.carta-text:nth-child(7) { animation-delay: 0.9s; }
.carta-text:nth-child(8) { animation-delay: 1s; }
.carta-text:nth-child(9) { animation-delay: 1.1s; }
.carta-text:nth-child(10) { animation-delay: 1.2s; }
.carta-text:nth-child(11) { animation-delay: 1.3s; }
.carta-text:nth-child(12) { animation-delay: 1.4s; }
.carta-text:nth-child(13) { animation-delay: 1.5s; }
.carta-text:nth-child(14) { animation-delay: 1.6s; }
.carta-text:nth-child(15) { animation-delay: 1.7s; }
.carta-text:nth-child(16) { animation-delay: 1.8s; }
.carta-text:nth-child(17) { animation-delay: 1.9s; }
.carta-text:nth-child(18) { animation-delay: 2s; }
.carta-text:nth-child(19) { animation-delay: 2.1s; }
.carta-text:nth-child(20) { animation-delay: 2.2s; }
.carta-text:nth-child(21) { animation-delay: 2.3s; }

@keyframes fadeIn {
  to { opacity: 1; }
}

.carta-decorations {
  display: flex;
  justify-content: space-between;
  margin-top: 40px;
  padding-top: 30px;
  border-top: 1px solid rgba(255, 255, 255, 0.2);
  opacity: 0;
  animation: fadeIn 0.8s ease 2.4s forwards;
}

.carta-decoration-img {
  width: 140px;
  height: 140px;
  object-fit: contain;
  animation: float 3s ease-in-out infinite;
  filter: drop-shadow(0 4px 12px rgba(255, 100, 150, 0.3));
}

.carta-decoration-img:nth-child(1) {
  animation-delay: 0s;
}

.carta-decoration-img:nth-child(2) {
  animation-delay: 1.5s;
}

@keyframes float {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-15px);
  }
}

/* Canvas para animaciones de part√≠culas */
#particles-canvas {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 199;
  display: none;
}

#particles-canvas.active {
  display: block;
}

/* Scrollbar personalizado para la carta */
#carta-container::-webkit-scrollbar {
  width: 8px;
}

#carta-container::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

#carta-container::-webkit-scrollbar-thumb {
  background: rgba(255, 100, 150, 0.4);
  border-radius: 10px;
}

#carta-container::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 100, 150, 0.6);
}

/* Responsive */
@media (max-width: 768px) {
  #carta-container {
    padding: 32px 24px;
    max-width: 95%;
  }
  
  .carta-title {
    font-size: 26px;
    margin-bottom: 22px;
  }
  
  .carta-text {
    font-size: 15px;
    line-height: 1.7;
  }
  
  .carta-decoration-img {
    width: 100px;
    height: 100px;
  }
  
  #close-carta-btn {
    width: 32px;
    height: 32px;
    font-size: 20px;
  }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/three@0.126.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.126.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
<canvas id="galaxy-canvas"></canvas>
<canvas id="fx"></canvas>
<canvas id="particles-canvas"></canvas>

<div id="err" class="error"></div>

<button id="cartita-btn">
  <img src="Dudu10.gif" alt="Cartita">
</button>
<div id="cartita-label">Tocar aquiiii</div>

<audio id="audio" autoplay loop preload="auto" style="display:none">
  <source src="tequierotanto.mp3" type="audio/mpeg">
</audio>



<!-- Modal para la carta -->
<div id="carta-modal-overlay">
  <div id="carta-container">
    <button id="close-carta-btn">√ó</button>
    <h1 class="carta-title">Para ti Mi bonita üíå</h1>

    <p class="carta-text">Mi querida Cindy,</p>

    <p class="carta-text">¬øPuedes creerlo?! üò≠<br>
    Ya ha pasado un a√±o desde que todo empez√≥‚Ä¶ qui√©n dir√≠a que el tiempo pasar√≠a tan r√°pido. Hoy estamos aqu√≠, juntitos, mejores que nunca, construyendo algo tan bonito que a veces ni yo mismo me lo creo. üíñ</p>

    <p class="carta-text">¬øTe acuerdas del d√≠a que nos conocimos? üòä<br>
    Fue un jueves, un jueves como cualquiera, sin aviso, sin plan‚Ä¶ pero el destino ya ten√≠a escrita nuestra historia. Coincidimos justo en el momento indicado, y como si fuera magia, nos toc√≥ bailar juntos üëâüëà‚ú®</p>

    <p class="carta-text">Ese d√≠a no solo nos toc√≥ bailar, ese d√≠a naci√≥ algo.<br>
    Empez√≥ algo bonito.<br>
    Entre risas t√≠midas, miradas nuevas y esos nervios de conocer a alguien, t√∫ brillabas, como siempre. Ten√≠as esa vibra tuya, ese brillo que desde el primer momento me dej√≥ pensando en ti todo el d√≠a. Me atra√≠as sin remedio, sin que pudiera evitarlo.</p>

    <p class="carta-text">Yo te ve√≠a tan alegre, llena de energ√≠a, con esa forma de ser que iluminaba el lugar, mientras yo‚Ä¶ callado, desconfiado, escondido en mi propio silencio. Pero t√∫ lo rompiste. T√∫ fuiste la persona que me sac√≥ del silencio, la que me hizo sonre√≠r sin darme cuenta.</p>

    <p class="carta-text">Los d√≠as fueron pasando, y cada d√≠a me llamabas m√°s la atenci√≥n. Sin pensarlo, me fui enamorando de ti‚Ä¶ de tu brillo, de tu energ√≠a, de tus locuras, tus comentarios üòÖ, de tu forma de ver el mundo.</p>

    <p class="carta-text">Hasta que un d√≠a reun√≠ todo el valor ü´∂ y te ped√≠ que fueras mi enamorada.<br>
    Recuerdo esos nervios, ese miedo, esa carta que te le√≠ con la voz temblando ü•π jj‚Ä¶ y t√∫ aceptaste.<br>
    En ese momento sent√≠ que el coraz√≥n me explotaba de felicidad. Fui el chico m√°s feliz del mundo.</p>

    <p class="carta-text">Volv√≠ a casa con una sonrisa tan grande que no me cab√≠a en la cara, pensando en todo lo que vivir√≠amos juntos, en los momentos que nos esperaban, en la emoci√≥n de poder llamarte ‚Äúmi novia‚Äù. Y sin darme cuenta, ya te estaba amando con locura. ü•∫</p>

    <p class="carta-text">Desde entonces, mi vida cambi√≥.<br>
    Fuiste ‚Äîy eres‚Äî la persona que me hizo mejorar en todo sentido.<br>
    La que me ense√±√≥ a conocerme, a entenderme, a expresar lo que siento, a no ocultar mis emociones.<br>
    Fuiste la primera persona que me hizo sentir que amar vale la pena. üíó</p>

    <p class="carta-text">Agradezco a Dios cada d√≠a por haberte puesto en mi camino, por permitir que me elijas, que te quedes, que me acompa√±es. Porque sin saberlo, me fuiste salvando poquito a poquito.<br>
    T√∫ me ense√±as, me cuidas, me gu√≠as, me haces querer ser mejor.</p>

    <p class="carta-text">Y s√≠, solo nosotros sabemos lo mucho que nos cost√≥ llegar hasta aqu√≠. ü•∫<br>
    Las peleas, las l√°grimas, los silencios, las conversaciones largaaas, las veces que no sab√≠amos c√≥mo entendernos‚Ä¶ pero no nos rendimos. Lo intentamos siempre.<br>
    Y eso demuestra el amor tan sincero que tenemos los dos.</p>

    <p class="carta-text">Porque amar no siempre es f√°cil, pero contigo es bonito.<br>
    En cada mirada, cada abrazo, cada sonrisa, cada mensaje tuyo, cada demostraci√≥n de cari√±o‚Ä¶ ah√≠ est√° el amor. üíû</p>

    <p class="carta-text">Y tambi√©n est√°n los momentos felices üëâüëà‚ú®<br>
    Las risas tontas, los juegos con los amigos, las bromas entre nosotros (esas que solo t√∫ y yo entendemos üòÖ), los apodos, las ocurrencias, los momentos en que el mundo se detiene un ratito y solo existimos t√∫ y yo.<br>
    A veces pienso en todo eso y no puedo evitar sonre√≠r, porque me siento afortunado.<br>
    Afortunado de tenerte cerquita, de poder abrazarte, de compartir contigo mi d√≠a, mi tiempo, mi vida.</p>

    <p class="carta-text">Hoy, al mirar atr√°s, veo todo lo que hemos construido.<br>
    Un a√±o lleno de emociones, aventuras, momentos dif√≠ciles, risas, aprendizajes, pruebas de cari√±o, paciencia y comprensi√≥n.<br>
    Un a√±o en el que confirm√©, cada d√≠a, que t√∫ vales todo. ü•πüíó</p>

    <p class="carta-text">Gracias por ser t√∫.<br>
    Por aguantarme, por quedarte, por escuchar mis locuras, por abrazarme cuando lo necesito, por preocuparte por m√≠ aunque no te lo pida.<br>
    Gracias por amarme sin condiciones, por entender mis silencios, por ense√±arme a ser mejor persona, a ser m√°s paciente, m√°s tierno, m√°s fuerte.</p>

    <p class="carta-text">Y aqu√≠ estamos‚Ä¶ un a√±o despu√©s, y a√∫n siento los mismos nervios que la primera vez ü•π<br>
    Pensando en c√≥mo leer√°s esto, imaginando tu carita mientras lo haces üëâüëà<br>
    Un a√±o y a√∫n nos miramos con esos ojitos llenos de amor, ilusi√≥n y cari√±o.</p>

    <p class="carta-text">Mi bonita, mi ni√±a consentida, mi compa√±era, mi amor‚Ä¶<br>
    Gracias por hacer mi vida m√°s c√°lida, por llenarla de luz, de risas, de paz, de color.<br>
    Eres mi lugar seguro, mi calma, mi alegr√≠a.</p>

    <p class="carta-text">Prometo seguir a tu lado, seguir creciendo contigo, d√°ndote lo mejor de m√≠, haci√©ndote re√≠r siempre.<br>
    Cuidarte cuando te duela la cabeza ü•∫, apoyarte en tus metas, estar contigo en los d√≠as dif√≠ciles y celebrar los buenos con el coraz√≥n lleno.</p>

    <p class="carta-text">Porque nada de lo nuestro fue casualidad: fue destino, fue magia, fue amor. ‚ú®</p>

    <p class="carta-text">Ah, y antes de que termines de leer todo esto‚Ä¶<br>
    Quiero contarte algo m√°s ü•πüëâüëà</p>

    <p class="carta-text">Prepar√© esto con mucho cari√±o, con cada detalle pensado en ti.<br>
    Me llena de l√°grimas de emoci√≥n ü•π saber que es para ti.<br>
    :3 Te puse justo al centro porque ah√≠ es donde siempre est√°s ‚ù§Ô∏è<br>
    Y alrededor, orbitando, est√°n nuestras fotos, nuestros recuerdos, cada sonrisa, cada momento vivido‚Ä¶<br>
    Porque t√∫ eres eso para m√≠: mi universo. ü•πüíó</p>

    <p class="carta-text">Cada foto que gira a tu alrededor representa una parte de m√≠ que te ama.<br>
    Todo mi cari√±o, mi tiempo, mis pensamientos, todo gira en torno a ti.<br>
    Porque sin ti, nada tiene sentido, nada brilla igual.</p>

    <p class="carta-text">Y solo espero que te guste, mi amor, y puedas sentir todo lo que te quiero decir. ü•∫</p>

    <p class="carta-text">Por muchos a√±os m√°s contigo, mi amorcito.<br>
    Por todos los ‚Äúte amo‚Äù, los abrazos, los besos, las aventuras, las risas que a√∫n nos esperan.<br>
    Por todo lo que somos, y por todo lo que todav√≠a seremos.</p>

    <p class="carta-text"><strong>Feliz aniversario, mi bonita ü•πüíó</strong></p>

    <div class="carta-decorations">
      <img src="Dudu2.gif" alt="Dudu 2" class="carta-decoration-img">
      <img src="Dudu3.gif" alt="Dudu 3" class="carta-decoration-img">
    </div>
  </div>
</div>


<script>
(function() {
const err = document.getElementById("err");
function showError(msg) {
  err.textContent = msg;
  err.style.display = "block";
  setTimeout(() => err.style.display = "none", 5000);
}

// ====== AUTO AUDIO ========
const audio = document.getElementById("audio");
audio.volume = 0.4;

const tryPlay = () => {
  audio.play().catch(e => {
    console.log("Autoplay bloqueado, esperando interacci√≥n del usuario");
  });
};

const enableAudio = () => {
  audio.play().catch(() => {});
  document.removeEventListener('click', enableAudio);
  document.removeEventListener('touchstart', enableAudio);
};

tryPlay();
document.addEventListener('click', enableAudio, { once: true });
document.addEventListener('touchstart', enableAudio, { once: true });

// ====== WEBGL CHECK ========
try {
  const test = document.createElement('canvas').getContext('webgl') || 
                document.createElement('canvas').getContext('experimental-webgl');
  if (!test) throw new Error('WebGL no disponible');
} catch(e) {
  showError('WebGL desactivado. Usa Chrome/Edge/Firefox con aceleraci√≥n por hardware.');
  return;
}

// ====== THREE.JS SCENE ========
try {
  const canvas = document.getElementById('galaxy-canvas');
  const renderer = new THREE.WebGLRenderer({ 
    canvas, 
    antialias: true, 
    alpha: true 
  });
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputEncoding = THREE.sRGBEncoding;

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(
    75, 
    window.innerWidth / window.innerHeight, 
    0.1, 
    1000
  );
  
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.06;
  controls.minDistance = 15;
  controls.maxDistance = 100;

  function setCam() {
    const w = window.innerWidth, h = window.innerHeight;
    const isMobile = w < 768 || h < w;
    camera.fov = isMobile ? 65 : 40;
    camera.position.set(0, 8, isMobile ? 40 : 28);
    controls.target.set(0, 0, 0);
    camera.updateProjectionMatrix();
    controls.update();
  }
  setCam();

  // ====== FONDO ESTRELLADO ========
  function makePreciseTexture(size = 1024, count = 800) {
    const c = document.createElement('canvas');
    const ctx = c.getContext('2d');
    const w = c.width = size;
    const h = c.height = size;
    const r = size / 2;
    
    const bg = ctx.createRadialGradient(r, r, 0, r, r, r);
    bg.addColorStop(0, '#0a0015');
    bg.addColorStop(1, '#000000');
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, size, size);
    
    for (let i = 0; i < count; i++) {
      const x = Math.random() * size;
      const y = Math.random() * size;
      const base = Math.random() * 0.7 + 0.3;
      const glow = ctx.createRadialGradient(x, y, 0, x, y, Math.random() * 2 + 2.6);
      const huePick = Math.random();
      
      let colInner = `rgba(255,255,255,${(0.65 * base) ** 3})`;
      let colOuter = `rgba(180,190,255,${(0.12 * base) ** 3})`;
      
      if (huePick < 0.25) colOuter = `rgba(255,180,200,${(0.12 * base) ** 3})`;
      
      glow.addColorStop(0, colInner);
      glow.addColorStop(1, colOuter);
      ctx.fillStyle = glow;
      ctx.beginPath();
      ctx.arc(x, y, Math.random() * 1 + 0.6, 0, Math.PI * 2);
      ctx.fill();
    }
    
    return new THREE.CanvasTexture(c);
  }

  const bigGeo = new THREE.SphereGeometry(600, 60, 60);
  const starTex = makePreciseTexture(1024, 2000);
  starTex.wrapS = starTex.wrapT = THREE.RepeatWrapping;
  const bigMat = new THREE.MeshBasicMaterial({ 
    map: starTex, 
    side: THREE.BackSide, 
    transparent: true, 
    opacity: 0.85 
  });
  const bigSphere = new THREE.Mesh(bigGeo, bigMat);
  scene.add(bigSphere);

  // ====== FUNCI√ìN PARA CREAR PART√çCULAS DE TEXTO 3D ========
  function createTextParticles(text, particleCount = 2000) {
    const textGroup = new THREE.Group();
    
    const textCanvas = document.createElement('canvas');
    textCanvas.width = 512;
    textCanvas.height = 256;
    const textCtx = textCanvas.getContext('2d');
    
    textCtx.font = 'bold 120px Arial';
    textCtx.textAlign = 'center';
    textCtx.textBaseline = 'middle';
    textCtx.fillStyle = 'white';
    textCtx.fillText(text, 256, 128);
    
    const imageData = textCtx.getImageData(0, 0, 512, 256);
    const pixels = imageData.data;
    const textPixels = [];
    
    for (let y = 0; y < 256; y += 2) {
      for (let x = 0; x < 512; x += 2) {
        const i = (y * 512 + x) * 4;
        if (pixels[i + 3] > 128) {
          textPixels.push({
            x: (x / 512 - 0.5) * 20,
            y: -(y / 256 - 0.5) * 10
          });
        }
      }
    }
    
    const particleCanvas = document.createElement('canvas');
    particleCanvas.width = 64;
    particleCanvas.height = 64;
    const pCtx = particleCanvas.getContext('2d');
    
    const gradient = pCtx.createRadialGradient(32, 32, 0, 32, 32, 32);
    gradient.addColorStop(0, 'rgba(255, 100, 150, 1)');
    gradient.addColorStop(0.3, 'rgba(255, 50, 120, 0.8)');
    gradient.addColorStop(1, 'rgba(255, 0, 100, 0)');
    
    pCtx.fillStyle = gradient;
    pCtx.fillRect(0, 0, 64, 64);
    
    const particleTex = new THREE.CanvasTexture(particleCanvas);
    
    const positions = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    const sizes = new Float32Array(particleCount);
    
    for (let i = 0; i < particleCount; i++) {
      const pixel = textPixels[Math.floor(Math.random() * textPixels.length)];
      const scatter = (Math.random() - 0.5) * 0.5;
      
      positions[i * 3] = pixel.x + scatter;
      positions[i * 3 + 1] = pixel.y + scatter;
      positions[i * 3 + 2] = (Math.random() - 0.5) * 2;
      
      const colorVariation = Math.random() * 0.3;
      colors[i * 3] = 1;
      colors[i * 3 + 1] = 0.2 + colorVariation;
      colors[i * 3 + 2] = 0.4 + colorVariation;
      
      sizes[i] = Math.random() * 0.6 + 0.3;
    }
    
    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
    
    const material = new THREE.PointsMaterial({
      size: 0.4,
      map: particleTex,
      transparent: true,
      blending: THREE.AdditiveBlending,
      depthWrite: false,
      vertexColors: true,
      opacity: 0.9
    });
    
    const textParticles = new THREE.Points(geometry, material);
    textGroup.add(textParticles);
    
    return textGroup;
  }

  // ====== NOMBRE "CINDY" EN EL CENTRO DEL CORAZ√ìN ========
  const cindyText = createTextParticles("CINDY", 3000);
  cindyText.scale.set(0.5, 0.5, 0.5);
  cindyText.position.set(0, 2, 0);
  scene.add(cindyText);

  // ====== CORAZ√ìN 3D DE PART√çCULAS ========
  function createHeartParticles() {
    const heartGroup = new THREE.Group();
    
    function pointOnHeart(t) {
      const x = 16 * Math.pow(Math.sin(t), 3);
      const y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
      return { x, y };
    }

    const particleCanvas = document.createElement('canvas');
    particleCanvas.width = 64;
    particleCanvas.height = 64;
    const pCtx = particleCanvas.getContext('2d');
    
    const gradient = pCtx.createRadialGradient(32, 32, 0, 32, 32, 32);
    gradient.addColorStop(0, 'rgba(255, 100, 150, 1)');
    gradient.addColorStop(0.3, 'rgba(255, 50, 120, 0.8)');
    gradient.addColorStop(1, 'rgba(255, 0, 100, 0)');
    
    pCtx.fillStyle = gradient;
    pCtx.fillRect(0, 0, 64, 64);
    
    const particleTex = new THREE.CanvasTexture(particleCanvas);
    
    const particleCount = 3000;
    const positions = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    const sizes = new Float32Array(particleCount);
    
    for (let i = 0; i < particleCount; i++) {
      const t = (i / particleCount) * Math.PI * 2;
      const point = pointOnHeart(t);
      
      const depth = (Math.random() - 0.5) * 3;
      const scatter = (Math.random() - 0.5) * 1.5;
      
      positions[i * 3] = (point.x / 16) * 8 + scatter;
      positions[i * 3 + 1] = (point.y / 16) * 8 + scatter;
      positions[i * 3 + 2] = depth;
      
      const colorVariation = Math.random() * 0.3;
      colors[i * 3] = 1;
      colors[i * 3 + 1] = 0.2 + colorVariation;
      colors[i * 3 + 2] = 0.4 + colorVariation;
      
      sizes[i] = Math.random() * 0.8 + 0.4;
    }
    
    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
    
    const material = new THREE.PointsMaterial({
      size: 0.5,
      map: particleTex,
      transparent: true,
      blending: THREE.AdditiveBlending,
      depthWrite: false,
      vertexColors: true,
      opacity: 0.9
    });
    
    const heartParticles = new THREE.Points(geometry, material);
    heartGroup.add(heartParticles);
    
    return heartGroup;
  }

  const heartSystem = createHeartParticles();
  heartSystem.scale.set(1.8, 1.8, 1.8);
  scene.add(heartSystem);

  // ====== FRASE DE ANIVERSARIO ENCIMA DEL CORAZ√ìN ========
  function createAnniversaryText(text, particleCount = 4000) {
    const textGroup = new THREE.Group();
    
    const textCanvas = document.createElement('canvas');
    textCanvas.width = 1024;
    textCanvas.height = 256;
    const textCtx = textCanvas.getContext('2d');
    
    textCtx.font = 'bold 60px Arial';
    textCtx.textAlign = 'center';
    textCtx.textBaseline = 'middle';
    textCtx.fillStyle = 'white';
    textCtx.fillText(text, 512, 128);
    
    const imageData = textCtx.getImageData(0, 0, 1024, 256);
    const pixels = imageData.data;
    const textPixels = [];
    
    for (let y = 0; y < 256; y += 2) {
      for (let x = 0; x < 1024; x += 2) {
        const i = (y * 1024 + x) * 4;
        if (pixels[i + 3] > 128) {
          textPixels.push({
            x: (x / 1024 - 0.5) * 45,
            y: -(y / 256 - 0.5) * 11
          });
        }
      }
    }
    
    const particleCanvas = document.createElement('canvas');
    particleCanvas.width = 64;
    particleCanvas.height = 64;
    const pCtx = particleCanvas.getContext('2d');
    
    const gradient = pCtx.createRadialGradient(32, 32, 0, 32, 32, 32);
    gradient.addColorStop(0, 'rgba(255, 100, 150, 1)');
    gradient.addColorStop(0.3, 'rgba(255, 50, 120, 0.8)');
    gradient.addColorStop(1, 'rgba(255, 0, 100, 0)');
    
    pCtx.fillStyle = gradient;
    pCtx.fillRect(0, 0, 64, 64);
    
    const particleTex = new THREE.CanvasTexture(particleCanvas);
    
    const positions = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    const sizes = new Float32Array(particleCount);
    
    for (let i = 0; i < particleCount; i++) {
      const pixel = textPixels[Math.floor(Math.random() * textPixels.length)];
      const scatter = (Math.random() - 0.5) * 0.4;
      
      positions[i * 3] = pixel.x + scatter;
      positions[i * 3 + 1] = pixel.y + scatter;
      positions[i * 3 + 2] = (Math.random() - 0.5) * 2;
      
      const colorVariation = Math.random() * 0.3;
      colors[i * 3] = 1;
      colors[i * 3 + 1] = 0.2 + colorVariation;
      colors[i * 3 + 2] = 0.4 + colorVariation;
      
      sizes[i] = Math.random() * 0.5 + 0.25;
    }
    
    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
    
    const material = new THREE.PointsMaterial({
      size: 0.35,
      map: particleTex,
      transparent: true,
      blending: THREE.AdditiveBlending,
      depthWrite: false,
      vertexColors: true,
      opacity: 0.9
    });
    
    const textParticles = new THREE.Points(geometry, material);
    textGroup.add(textParticles);
    
    return textGroup;
  }

  const anniversaryText = createAnniversaryText("¬°Nuestro primer a√±o juntos!", 5000);
  anniversaryText.scale.set(0.7, 0.7, 0.7);
  anniversaryText.position.set(0, 18, 0);
  scene.add(anniversaryText);

  // ====== GALAXIA CON FRASES, TEXTOS ROM√ÅNTICOS Y FOTOS ========
  const galaxy = new THREE.Group();
  scene.add(galaxy);

  const romanticTexts = [
    "Mi bonita", "Mi ni√±a hermosa", "Te amooo", "06-11-2024",
    "Mi cielito", "Hermosura", "Mi todoo", "Siempre t√∫",
    "Mi vida", "Mi calma", "Mi amorcitoo", "T√∫ y yo",
    "C y D", "Mi universo", "Mi Babe ‚ù§Ô∏è", "Hermosa ‚ú®",
    "Me Encantas üòç", "Amor üíñ", "Te Amo üíï", "Mi cielito ‚≠ê",
    "Mi bonita", "Mi ni√±a hermosa", "Te amooo", "Mi todoo",
    "Siempre t√∫", "Mi vida", "Mi calma", "Mi amorcitoo",
    "T√∫ y yo", "C y D", "Mi universo", "Hermosura"
  ];

  const photoFiles = [
    "foto1.jpg", "foto2.jpg", "foto3.jpg", "foto4.jpg", "foto5.jpg",
    "foto6.jpg", "foto7.jpg", "foto8.jpg", "foto9.jpg", "foto10.jpg",
    "foto11.jpg", "foto12.jpg", "foto13.jpg", "foto14.jpg", "foto15.jpg",
    "foto16.jpg", "foto17.jpg", "foto18.jpg", "foto19.jpg", "foto20.jpg",
    "foto21.jpg", "foto22.jpg"
  ];

  const radius = 30;
  const orbitingItems = [];

  function makeTextTexture(text, size = 40) {
    const c = document.createElement('canvas');
    const ctx = c.getContext('2d');
    c.width = size * 10;
    c.height = size * 2;
    ctx.font = `700 ${size}px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(255, 150, 200, 0.95)';
    ctx.shadowBlur = 35;

    const gradient = ctx.createLinearGradient(0, 0, c.width, 0);
    gradient.addColorStop(0, 'rgba(255, 220, 240, 1)');
    gradient.addColorStop(0.5, 'rgba(255, 180, 220, 1)');
    gradient.addColorStop(1, 'rgba(255, 150, 200, 1)');
    ctx.fillStyle = gradient;
    ctx.fillText(text, c.width / 2, c.height / 2);
    return new THREE.CanvasTexture(c);
  }

  // A√±adir textos rom√°nticos con efecto de fade y brillo
  for (let i = 0; i < romanticTexts.length; i++) {
    const text = romanticTexts[i];
    const tex = makeTextTexture(text, 38);
    const spMat = new THREE.SpriteMaterial({
      map: tex,
      transparent: true,
      depthWrite: false
    });
    const sp = new THREE.Sprite(spMat);
    const ang = Math.random() * Math.PI * 2;
    const heightOffset = (Math.random() - 0.5) * 12;

    sp.scale.set(5, 2.5, 1);
    sp.userData = {
      angle: ang,
      baseRadius: radius,
      currentRadius: radius,
      speed: 0.018 + Math.random() * 0.012,
      heightOffset: heightOffset,
      rotationSpeed: 0.003 + Math.random() * 0.004,
      type: 'text'
    };

    galaxy.add(sp);
    orbitingItems.push(sp);
  }

  // A√±adir fotos m√°s peque√±as y con proporci√≥n cuadrada
  const textureLoader = new THREE.TextureLoader();
  for (let i = 0; i < photoFiles.length; i++) {
    const ang = Math.random() * Math.PI * 2;
    const heightOffset = (Math.random() - 0.5) * 10;
    
    const placeholderCanvas = document.createElement('canvas');
    placeholderCanvas.width = 512;
    placeholderCanvas.height = 512;
    const pCtx = placeholderCanvas.getContext('2d');

    const grad = pCtx.createLinearGradient(0, 0, 512, 512);
    grad.addColorStop(0, 'rgba(255, 150, 200, 0.8)');
    grad.addColorStop(1, 'rgba(255, 100, 150, 0.8)');
    pCtx.fillStyle = grad;

    pCtx.beginPath();
    pCtx.roundRect(20, 20, 472, 472, 30);
    pCtx.fill();

    pCtx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    pCtx.font = 'bold 24px Arial';
    pCtx.textAlign = 'center';
    pCtx.textBaseline = 'middle';
    pCtx.fillText(photoFiles[i], 256, 256);

    const placeholderTex = new THREE.CanvasTexture(placeholderCanvas);

    const photoMat = new THREE.SpriteMaterial({
      map: placeholderTex,
      transparent: true,
      depthWrite: false
    });

    const photoSprite = new THREE.Sprite(photoMat);
    photoSprite.scale.set(3.2, 3.2, 1);
    photoSprite.userData = {
      angle: ang,
      baseRadius: radius,
      currentRadius: radius,
      speed: 0.016 + Math.random() * 0.01,
      heightOffset: heightOffset,
      rotationSpeed: 0.003 + Math.random() * 0.004,
      type: 'photo'
    };

    galaxy.add(photoSprite);
    orbitingItems.push(photoSprite);

    textureLoader.load(
      photoFiles[i],
      (texture) => {
        const processedCanvas = document.createElement('canvas');
        processedCanvas.width = 512;
        processedCanvas.height = 512;
        const processedCtx = processedCanvas.getContext('2d');
        
        processedCtx.beginPath();
        processedCtx.roundRect(0, 0, 512, 512, 30);
        processedCtx.clip();
        
        const img = texture.image;
        const size = Math.min(img.width, img.height);
        const x = (img.width - size) / 2;
        const y = (img.height - size) / 2;
        
        processedCtx.drawImage(img, x, y, size, size, 0, 0, 512, 512);
        
        const processedTex = new THREE.CanvasTexture(processedCanvas);
        photoMat.map = processedTex;
        photoMat.needsUpdate = true;
      },
      undefined,
      (error) => {
        console.log(`No se pudo cargar ${photoFiles[i]}, usando placeholder`);
      }
    );
  }

  // Estrellas peque√±as alrededor
  const starCount = 1500;
  const starGeo = new THREE.BufferGeometry();
  const starPos = new Float32Array(starCount * 3);
  for (let i = 0; i < starCount; i++) {
    const ang = Math.random() * Math.PI * 2;
    const dist = Math.random() * radius + 15;
    const y = (Math.random() - 0.5) * 20;
    starPos[i * 3] = Math.cos(ang) * dist;
    starPos[i * 3 + 1] = y;
    starPos[i * 3 + 2] = Math.sin(ang) * dist;
  }
  starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
  const starMat = new THREE.PointsMaterial({
    color: '#ffffff',
    size: 0.25,
    transparent: true,
    opacity: 0.7,
    blending: THREE.AdditiveBlending
  });
  galaxy.add(new THREE.Points(starGeo, starMat));

  // ====== ANIMACI√ìN ========
  let time = 0;
  function animate() {
    requestAnimationFrame(animate);
    time += 0.016;

    starTex.offset.set((time * 0.0001) % 1, 0);

    orbitingItems.forEach(item => {
      item.userData.currentRadius -= item.userData.speed * 0.12;
      item.userData.angle += item.userData.rotationSpeed;
      
      const fadeStart = item.userData.baseRadius * 0.5;
      const fadeEnd = 2;
      let opacity = 1;
      
      if (item.userData.currentRadius < fadeStart) {
        opacity = (item.userData.currentRadius - fadeEnd) / (fadeStart - fadeEnd);
        opacity = Math.max(0, Math.min(1, opacity));
      }
      
      if (item.userData.currentRadius <= fadeEnd) {
        item.userData.currentRadius = item.userData.baseRadius;
        item.userData.angle = Math.random() * Math.PI * 2;
        item.userData.heightOffset = (Math.random() - 0.5) * (item.userData.type === 'photo' ? 10 : 12);
        opacity = 0;
      }
      
      if (item.userData.currentRadius > item.userData.baseRadius * 0.85) {
        const fadeInProgress = (item.userData.baseRadius - item.userData.currentRadius) / (item.userData.baseRadius * 0.15);
        opacity = Math.min(opacity, fadeInProgress);
      }
      
      const x = Math.cos(item.userData.angle) * item.userData.currentRadius;
      const z = Math.sin(item.userData.angle) * item.userData.currentRadius;
      const y = item.userData.heightOffset + Math.sin(time * 0.5 + item.userData.angle) * 1.5;
      
      item.position.set(x, y, z);
      item.material.opacity = Math.max(0, Math.min(1, opacity));
    });

    galaxy.rotation.y = time * 0.05;

    const pulse = Math.sin(time * 1.5) * 0.08 + 1;
    heartSystem.scale.set(1.8 * pulse, 1.8 * pulse, 1.8 * pulse);
    heartSystem.rotation.y = time * 0.15;
    heartSystem.rotation.z = Math.sin(time * 0.5) * 0.1;

    cindyText.scale.set(0.5 * pulse, 0.5 * pulse, 0.5 * pulse);
    cindyText.rotation.y = time * 0.1;

    anniversaryText.position.y = 18 + Math.sin(time * 0.8) * 1.5;
    anniversaryText.rotation.y = Math.sin(time * 0.3) * 0.1;

    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // ====== RESPONSIVE ========
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    setCam();
  });

} catch(e) {
  showError('Error cargando la galaxia: ' + e.message);
  console.error(e);
}

// ====== CORAZONES FLOTANTES (2D) ========
const fx = document.getElementById("fx");
const ctx2 = fx.getContext("2d");

function resizeFx() {
  const dpr = Math.min(2, window.devicePixelRatio);
  fx.width = Math.floor(innerWidth * dpr);
  fx.height = Math.floor(innerHeight * dpr);
  fx.style.width = innerWidth + "px";
  fx.style.height = innerHeight + "px";
  ctx2.scale(dpr, dpr);
}
addEventListener("resize", resizeFx);
resizeFx();

const hearts = [];
function spawnHeart(x, y, size) {
  hearts.push({
    x,
    y,
    size,
    vx: (Math.random() - 0.5) * 3,
    vy: -Math.random() * 3 - 1,
    life: 1,
    rotation: Math.random() * Math.PI * 2
  });
}

function drawHeart(x, y, size, rotation) {
  const s = size;
  ctx2.save();
  ctx2.translate(x, y);
  ctx2.rotate(rotation);
  ctx2.beginPath();
  ctx2.moveTo(0, -0.25 * s);
  ctx2.bezierCurveTo(0, -0.5 * s, 0.5 * s, -0.5 * s, 0.5 * s, -0.25 * s);
  ctx2.bezierCurveTo(0.5 * s, 0, 0, 0.4 * s, 0, 0.6 * s);
  ctx2.bezierCurveTo(0, 0.4 * s, -0.5 * s, 0, -0.5 * s, -0.25 * s);
  ctx2.bezierCurveTo(-0.5 * s, -0.5 * s, 0, -0.5 * s, 0, -0.25 * s);
  const g = ctx2.createRadialGradient(0, 0, 0, 0, 0, s);
  g.addColorStop(0, 'rgba(255, 100, 150, 0.9)');
  g.addColorStop(1, 'rgba(255, 50, 120, 0)');
  ctx2.fillStyle = g;
  ctx2.fill();
  ctx2.restore();
}

let lastTap = 0;
addEventListener('click', (e) => {
  const tap = performance.now();
  if (tap - lastTap < 300) {
    spawnHeart(e.clientX, e.clientY, 25);
  }
  lastTap = tap;
}, { passive: true });

addEventListener('touchend', (e) => {
  const tap = performance.now();
  const tc = e.changedTouches[0];
  if (tap - lastTap < 300) {
    spawnHeart(tc.clientX, tc.clientY, 25);
  }
  lastTap = tap;
}, { passive: true });

function loop() {
  ctx2.clearRect(0, 0, fx.width / Math.min(2, window.devicePixelRatio),
                 fx.height / Math.min(2, window.devicePixelRatio));
  
  for (let i = hearts.length - 1; i >= 0; i--) {
    const h = hearts[i];
    h.x += h.vx;
    h.y += h.vy;
    h.vy += 0.08;
    h.rotation += 0.05;
    h.life -= 0.012;
    
    if (h.life <= 0) {
      hearts.splice(i, 1);
      continue;
    }

    ctx2.globalAlpha = h.life;
    drawHeart(h.x, h.y, h.size, h.rotation);
  }
  ctx2.globalAlpha = 1;
  requestAnimationFrame(loop);
}
loop();

// ====== ANIMACI√ìN DE PART√çCULAS (CORAZONES Y FLORES) ========
const particlesCanvas = document.getElementById('particles-canvas');
const particlesCtx = particlesCanvas.getContext('2d');

particlesCanvas.width = window.innerWidth;
particlesCanvas.height = window.innerHeight;

let particles = [];
let particleAnimationId = null;
let openCartaTimeout = null;

// Crear part√≠cula de coraz√≥n
function createHeartParticle(x, y) {
  const centerX = window.innerWidth / 2;
  const centerY = window.innerHeight / 2;
  
  const angle = Math.atan2(centerY - y, centerX - x);
  const speed = 3 + Math.random() * 2;
  
  return {
    x: x,
    y: y,
    vx: Math.cos(angle) * speed,
    vy: Math.sin(angle) * speed,
    targetX: centerX + (Math.random() - 0.5) * 200,
    targetY: centerY + (Math.random() - 0.5) * 200,
    size: 15 + Math.random() * 15,
    rotation: Math.random() * Math.PI * 2,
    rotationSpeed: (Math.random() - 0.5) * 0.15,
    life: 1,
    type: 'heart',
    sparkle: Math.random() > 0.5,
    birthTime: Date.now()
  };
}

// Crear part√≠cula de flor
function createFlowerParticle(x, y) {
  const centerX = window.innerWidth / 2;
  const centerY = window.innerHeight / 2;
  
  const angle = Math.atan2(centerY - y, centerX - x);
  const speed = 3 + Math.random() * 2;
  
  return {
    x: x,
    y: y,
    vx: Math.cos(angle) * speed,
    vy: Math.sin(angle) * speed,
    targetX: centerX + (Math.random() - 0.5) * 200,
    targetY: centerY + (Math.random() - 0.5) * 200,
    size: 10 + Math.random() * 10,
    rotation: Math.random() * Math.PI * 2,
    rotationSpeed: (Math.random() - 0.5) * 0.2,
    life: 1,
    type: 'flower',
    petalCount: 5 + Math.floor(Math.random() * 3),
    hue: Math.random() * 60 + 300,
    birthTime: Date.now()
  };
}

// Dibujar coraz√≥n
function drawHeartParticle(particle) {
  particlesCtx.save();
  particlesCtx.translate(particle.x, particle.y);
  particlesCtx.rotate(particle.rotation);
  
  const alpha = particle.life;
  particlesCtx.globalAlpha = alpha * (particle.sparkle ? 0.7 + Math.sin(Date.now() * 0.01) * 0.3 : 1);
  
  const s = particle.size;
  particlesCtx.beginPath();
  particlesCtx.moveTo(0, -0.25 * s);
  particlesCtx.bezierCurveTo(0, -0.5 * s, 0.5 * s, -0.5 * s, 0.5 * s, -0.25 * s);
  particlesCtx.bezierCurveTo(0.5 * s, 0, 0, 0.4 * s, 0, 0.6 * s);
  particlesCtx.bezierCurveTo(0, 0.4 * s, -0.5 * s, 0, -0.5 * s, -0.25 * s);
  particlesCtx.bezierCurveTo(-0.5 * s, -0.5 * s, 0, -0.5 * s, 0, -0.25 * s);
  
  const gradient = particlesCtx.createRadialGradient(0, 0, 0, 0, 0, s);
  gradient.addColorStop(0, 'rgba(255, 100, 150, 1)');
  gradient.addColorStop(0.5, 'rgba(255, 50, 120, 0.9)');
  gradient.addColorStop(1, 'rgba(255, 0, 100, 0.3)');
  particlesCtx.fillStyle = gradient;
  particlesCtx.shadowColor = 'rgba(255, 100, 150, 0.8)';
  particlesCtx.shadowBlur = particle.sparkle ? 25 : 15;
  particlesCtx.fill();
  
  particlesCtx.restore();
}

// Dibujar flor
function drawFlowerParticle(particle) {
  particlesCtx.save();
  particlesCtx.translate(particle.x, particle.y);
  particlesCtx.rotate(particle.rotation);
  
  particlesCtx.globalAlpha = particle.life;
  
  const s = particle.size;
  const petalCount = particle.petalCount;
  
  // Dibujar p√©talos
  for (let i = 0; i < petalCount; i++) {
    const angle = (Math.PI * 2 * i) / petalCount;
    particlesCtx.save();
    particlesCtx.rotate(angle);
    
    particlesCtx.beginPath();
    particlesCtx.ellipse(0, -s * 0.4, s * 0.3, s * 0.5, 0, 0, Math.PI * 2);
    
    const gradient = particlesCtx.createRadialGradient(0, -s * 0.4, 0, 0, -s * 0.4, s * 0.5);
    gradient.addColorStop(0, `hsla(${particle.hue}, 80%, 70%, 1)`);
    gradient.addColorStop(0.7, `hsla(${particle.hue}, 70%, 60%, 0.8)`);
    gradient.addColorStop(1, `hsla(${particle.hue}, 60%, 50%, 0.3)`);
    particlesCtx.fillStyle = gradient;
    particlesCtx.shadowColor = `hsla(${particle.hue}, 80%, 70%, 0.6)`;
    particlesCtx.shadowBlur = 10;
    particlesCtx.fill();
    
    particlesCtx.restore();
  }
  
  // Centro de la flor
  particlesCtx.beginPath();
  particlesCtx.arc(0, 0, s * 0.2, 0, Math.PI * 2);
  particlesCtx.fillStyle = 'rgba(255, 220, 100, 0.9)';
  particlesCtx.shadowColor = 'rgba(255, 220, 100, 0.6)';
  particlesCtx.shadowBlur = 8;
  particlesCtx.fill();
  
  particlesCtx.restore();
}

// Lanzar part√≠culas desde los bordes
function launchParticles() {
  const particleCount = 80;
  
  for (let i = 0; i < particleCount; i++) {
    const edge = Math.floor(Math.random() * 4);
    let x, y;
    
    switch(edge) {
      case 0:
        x = Math.random() * window.innerWidth;
        y = -20;
        break;
      case 1:
        x = window.innerWidth + 20;
        y = Math.random() * window.innerHeight;
        break;
      case 2:
        x = Math.random() * window.innerWidth;
        y = window.innerHeight + 20;
        break;
      case 3:
        x = -20;
        y = Math.random() * window.innerHeight;
        break;
    }
    
    if (Math.random() < 0.6) {
      particles.push(createHeartParticle(x, y));
    } else {
      particles.push(createFlowerParticle(x, y));
    }
  }
}

// Animar part√≠culas
function animateParticles() {
  particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
  
  const now = Date.now();
  
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    
    const dx = p.targetX - p.x;
    const dy = p.targetY - p.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    
    if (dist > 5) {
      const attractionForce = 0.15;
      p.vx += (dx / dist) * attractionForce;
      p.vy += (dy / dist) * attractionForce;
      
      const maxSpeed = 10;
      const currentSpeed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
      if (currentSpeed > maxSpeed) {
        p.vx = (p.vx / currentSpeed) * maxSpeed;
        p.vy = (p.vy / currentSpeed) * maxSpeed;
      }
      
      p.vx *= 0.98;
      p.vy *= 0.98;
      
      p.x += p.vx;
      p.y += p.vy;
    } else {
      p.x = p.targetX;
      p.y = p.targetY;
      p.vx = 0;
      p.vy = 0;
    }
    
    p.rotation += p.rotationSpeed;
    
    // Fade out despu√©s de 4.5 segundos
    if (now - p.birthTime > 4500) {
      p.life -= 0.015;
    }
    
    if (p.life <= 0) {
      particles.splice(i, 1);
      continue;
    }
    
    if (p.type === 'heart') {
      drawHeartParticle(p);
    } else {
      drawFlowerParticle(p);
    }
  }
  
  if (particles.length > 0) {
    particleAnimationId = requestAnimationFrame(animateParticles);
  } else {
    particlesCanvas.classList.remove('active');
  }
}

// ====== CARTA MODAL FUNCTIONALITY ========
const cartitaBtn = document.getElementById('cartita-btn');
const cartaModalOverlay = document.getElementById('carta-modal-overlay');
const closeCartaBtn = document.getElementById('close-carta-btn');

// Abrir carta con animaci√≥n de part√≠culas
cartitaBtn.addEventListener('click', () => {
  // Limpiar timeouts previos
  if (openCartaTimeout) {
    clearTimeout(openCartaTimeout);
    openCartaTimeout = null;
  }
  
  // Limpiar animaci√≥n anterior
  if (particleAnimationId) {
    cancelAnimationFrame(particleAnimationId);
    particleAnimationId = null;
  }
  
  particles = [];
  particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
  
  // Lanzar part√≠culas
  particlesCanvas.classList.add('active');
  launchParticles();
  animateParticles();
  
  // Abrir modal despu√©s de 2 segundos (para que las part√≠culas lleguen m√°s al centro)
  openCartaTimeout = setTimeout(() => {
    cartaModalOverlay.classList.add('active');
  }, 2000);
});

// Cerrar carta con animaci√≥n
closeCartaBtn.addEventListener('click', () => {
  cartaModalOverlay.classList.add('closing');
  
  setTimeout(() => {
    cartaModalOverlay.classList.remove('active', 'closing');
    
    // Limpiar part√≠culas
    if (particleAnimationId) {
      cancelAnimationFrame(particleAnimationId);
      particleAnimationId = null;
    }
    particles = [];
    particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
    particlesCanvas.classList.remove('active');
    
    // Limpiar timeout si existe
    if (openCartaTimeout) {
      clearTimeout(openCartaTimeout);
      openCartaTimeout = null;
    }
  }, 500);
});

// Cerrar al hacer click fuera de la carta
cartaModalOverlay.addEventListener('click', (e) => {
  if (e.target === cartaModalOverlay) {
    closeCartaBtn.click();
  }
});

// Responsive
window.addEventListener('resize', () => {
  particlesCanvas.width = window.innerWidth;
  particlesCanvas.height = window.innerHeight;
});

})();
</script>
</body>
</html>
